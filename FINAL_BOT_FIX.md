# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ë–û–¢–ê - –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø

## üö® –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. **FSM Storage –ø—Ä–æ–±–ª–µ–º–∞**
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: `Dispatcher()` —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è storage ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è MemoryStorage –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω RedisStorage —Å fallback –Ω–∞ MemoryStorage –≤ `main.py`

### 2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ check_premium —Ñ—É–Ω–∫—Ü–∏–∏**
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: –î–≤–µ —Ä–∞–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ `check_premium` - –æ–¥–Ω–∞ –≤ `user_handlers.py` (—á–µ—Ä–µ–∑ API), –¥—Ä—É–≥–∞—è –≤ `payment_operations.py` (—á–µ—Ä–µ–∑ –ë–î)
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ `user_handlers.py`, –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏—è –∏–∑ `payment_operations.py`

### 3. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π**
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: –ú–Ω–æ–≥–æ `await state.clear()` –≤ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –º–µ—Å—Ç–∞—Ö, —á—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–ª–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã `addmeal`, `water`, `mood` - —Ç–µ–ø–µ—Ä—å –æ–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ set_state**
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –±—ã–ª–æ –¥–≤–∞ `await state.set_state()` –ø–æ–¥—Ä—è–¥
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã

### 5. **Systemd unit –¥–ª—è –±–æ—Ç–∞**
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ systemd unit –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω `bot.service` —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

---

## ‚ö° –≠–ö–°–¢–†–ï–ù–ù–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –£–ë–ò–¢–¨ –í–°–ï –ü–†–û–¶–ï–°–°–´ –ë–û–¢–ê
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å systemd —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl stop api frontend nginx bot

# –£–±–∏—Ç—å –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã Python
sudo pkill -f "python.*main.py"
sudo pkill -f "python.*main"
sudo pkill -f "python.*improved_api_server"
sudo pkill -f "python.*start_all_services"

# –£–±–∏—Ç—å npm –ø—Ä–æ—Ü–µ—Å—Å—ã
sudo pkill -f "npm"
sudo pkill -f "vite"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Ä—Ç—ã
sudo lsof -ti :8000 | xargs sudo kill -9 2>/dev/null || true
sudo lsof -ti :80 | xargs sudo kill -9 2>/dev/null || true
sudo lsof -ti :5173 | xargs sudo kill -9 2>/dev/null || true

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —É–±–∏—Ç—ã
ps aux | grep -E "(python|npm)" | grep -v grep
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ü–£–°–¢–û!
```

### 2. –ó–ê–ü–£–°–¢–ò–¢–¨ –≠–ö–°–¢–†–ï–ù–ù–´–ô –°–ö–†–ò–ü–¢
```bash
# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/dieta

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
python emergency_restart.py
```

### 3. –ò–õ–ò –ó–ê–ü–£–°–¢–ò–¢–¨ –í–†–£–ß–ù–£–Æ
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å systemd
sudo systemctl daemon-reload

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
sudo systemctl enable --now api
sudo systemctl enable --now frontend
sudo systemctl enable --now nginx
sudo systemctl enable --now bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status api frontend nginx bot
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò

### –¢–µ—Å—Ç 1: –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç
```bash
# –í Telegram: /start
# –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```

### –¢–µ—Å—Ç 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–¥—ã
```bash
# –í Telegram: "–î–æ–±–∞–≤–∏—Ç—å –µ–¥—É"
# –í–≤–µ—Å—Ç–∏: "–Ø–±–ª–æ–∫–æ 150"
# –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –¥–Ω–µ–≤–Ω–∏–∫
# –ù–ï –¥–æ–ª–∂–µ–Ω —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
```

### –¢–µ—Å—Ç 3: –¢—Ä–µ–∫–µ—Ä –≤–æ–¥—ã
```bash
# –í Telegram: "–¢—Ä–µ–∫–µ—Ä –≤–æ–¥—ã"
# –í–≤–µ—Å—Ç–∏: "500"
# –î–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–¥—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
# –ù–ï –¥–æ–ª–∂–µ–Ω —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
```

### –¢–µ—Å—Ç 4: –ü—Ä–æ—Ñ–∏–ª—å
```bash
# –í Telegram: "–ü—Ä–æ—Ñ–∏–ª—å"
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# –ù–ï –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å–∏—Ç—å "–≤–≤–µ–¥–∏—Ç–µ –≤–æ–¥—É"
```

### –¢–µ—Å—Ç 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```bash
# –í Telegram: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∏—Ç–∞–Ω–∏—è
# –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
```

---

## üîß –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û –í –ö–û–î–ï

### 1. FSM Storage –≤ main.py
```python
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ —Å Redis storage –¥–ª—è FSM
try:
    storage = RedisStorage.from_url("redis://localhost:6379/0")
    logger.info("‚úÖ Redis storage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
except Exception as e:
    from aiogram.fsm.storage.memory import MemoryStorage
    storage = MemoryStorage()
    logger.info("‚úÖ MemoryStorage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

dp = Dispatcher(storage=storage)
```

### 2. –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è check_premium
- –£–¥–∞–ª–µ–Ω–∞ –∏–∑ `components/handlers/user_handlers.py`
- –û—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏—è –∏–∑ `components/payment_system/payment_operations.py`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤–æ –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
- ‚úÖ **addmeal_command** ‚Üí —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `AddMealFSM.waiting`
- ‚úÖ **water_command** ‚Üí —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `WaterFSM.add`
- ‚úÖ **mood_command** ‚Üí —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ `MoodFSM.waiting`

### 4. –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ set_state
- –£–±—Ä–∞–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã `await state.set_state()` –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- –û—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –≤—ã–∑–æ–≤—ã

### 5. –°–æ–∑–¥–∞–Ω bot.service
```ini
[Unit]
Description=Dieta Telegram Bot
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/dieta
ExecStart=/opt/dieta/venv/bin/python main.py
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
```bash
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¢–û–õ–¨–ö–û –û–î–ù–ê —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –±–æ—Ç–∞
ps aux | grep 'main.py' | grep -v grep

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã
netstat -tlnp | grep -E "(8000|80|5173)"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
```bash
# –ë–æ—Ç
sudo journalctl -u bot -f

# API
sudo journalctl -u api -f

# Frontend
sudo journalctl -u frontend -f
```

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ **1 –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞** (–Ω–µ 6!)
- ‚úÖ **–ö–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Üí –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
- ‚úÖ **–°–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** ‚Üí FSM —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Üí check_premium —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **API –æ—Ç–≤–µ—á–∞–µ—Ç** ‚Üí /api/health —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç** ‚Üí YooKassa 1097156

---

## üö® –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–´ –û–°–¢–ê–Æ–¢–°–Ø

### –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ
sudo systemctl stop api frontend nginx bot
sudo pkill -f python
sudo pkill -f npm

# –ü–æ–¥–æ–∂–¥–∞—Ç—å
sleep 10

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
sudo systemctl start api frontend nginx bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
sudo systemctl status api frontend nginx bot
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
# Service —Ñ–∞–π–ª—ã
sudo cat /etc/systemd/system/bot.service
sudo cat /etc/systemd/system/api.service

# .env —Ñ–∞–π–ª
cat .env | grep -E "(TG_TOKEN|YOOKASSA|API_BASE_URL)"
```

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í GIT

–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–∂–µ –≤–Ω–µ—Å–µ–Ω—ã –≤ –∫–æ–¥ –∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—É—à—É:

```bash
# –î–æ–±–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add .

# –°–æ–∑–¥–∞—Ç—å –∫–æ–º–º–∏—Ç
git commit -m "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π –±–æ—Ç–∞

- –î–æ–±–∞–≤–ª–µ–Ω RedisStorage —Å fallback –Ω–∞ MemoryStorage
- –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è check_premium
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –∫–æ–º–∞–Ω–¥
- –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ set_state –≤—ã–∑–æ–≤—ã
- –°–æ–∑–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π systemd unit –¥–ª—è –±–æ—Ç–∞
- –û–±–Ω–æ–≤–ª–µ–Ω emergency_restart.py —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
git push origin main
```

---

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥:
- ‚úÖ **–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ**
- ‚úÖ **–ö–æ–º–∞–Ω–¥—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è**
- ‚úÖ **–°–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è**
- ‚úÖ **–ü–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç**
- ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç**

**–ì–æ—Ç–æ–≤–æ! –ë–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! üöÄ** 