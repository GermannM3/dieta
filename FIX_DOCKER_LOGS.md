# üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –° –õ–û–ì–ê–ú–ò DOCKER

## üìä –ü—Ä–æ–±–ª–µ–º–∞

Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–æ—Å–æ–±–µ–Ω–Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –±–æ—Ç) –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç –ª–æ–≥–∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ **–∑–∞—Ö–ª–∞–º–ª—è—é—Ç –¥–∏—Å–∫**.

### –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:

1. ‚úÖ **docker-compose.yml** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
2. ‚úÖ **nginx-frontend.conf** - –æ—Ç–∫–ª—é—á–µ–Ω—ã access –ª–æ–≥–∏ (—Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏)
3. ‚úÖ **cleanup_docker_logs.sh** - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ª–æ–≥–æ–≤

---

## ‚ö° –ë–´–°–¢–†–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–≥–∏

```bash
# –î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
chmod +x cleanup_docker_logs.sh

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—á–∏—Å—Ç–∫—É
sudo bash cleanup_docker_logs.sh
```

–°–∫—Ä–∏–ø—Ç:
- –ü–æ–∫–∞–∂–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –û—á–∏—Å—Ç–∏—Ç –≤—Å–µ –ª–æ–≥–∏
- –ó–∞–ø—É—Å—Ç–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ Docker
sudo du -sh /var/lib/docker/containers/*/

# –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä
sudo du -sh /var/lib/docker/containers/
```

### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
docker-compose down
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose ps
```

---

## üìù –ß–¢–û –ò–ó–ú–ï–ù–ï–ù–û

### 1. docker-compose.yml - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ª–æ–≥–∏

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ª–æ–≥–∞
    max-file: "3"      # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- **Bot**: –º–∞–∫—Å 10MB x 3 —Ñ–∞–π–ª–∞ = **30MB**
- **API**: –º–∞–∫—Å 10MB x 3 —Ñ–∞–π–ª–∞ = **30MB**  
- **Frontend**: –º–∞–∫—Å 5MB x 2 —Ñ–∞–π–ª–∞ = **10MB**
- **Nginx**: –º–∞–∫—Å 5MB x 2 —Ñ–∞–π–ª–∞ = **10MB**

**–û–±—â–∏–π –º–∞–∫—Å–∏–º—É–º –ª–æ–≥–æ–≤: ~80MB** (–≤–º–µ—Å—Ç–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞)

### 2. nginx-frontend.conf - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```nginx
# –û—Ç–∫–ª—é—á–µ–Ω—ã access –ª–æ–≥–∏ (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Ñ–∞–π–ª–∞–º)
access_log off;

# –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
error_log /var/log/nginx/error.log error;
```

---

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –° –ë–û–¢–û–ú

–ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ **"Restarting (1)"** - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –æ–Ω **–ø–∞–¥–∞–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è**.

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞
docker logs dieta-bot-1 --tail 100

# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker logs dieta-bot-1 -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏
docker logs dieta-bot-1 --tail 50 2>&1 | grep -i error
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–∞–¥–µ–Ω–∏—è –±–æ—Ç–∞:

1. **–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç
   curl http://localhost:8000/health
   ```

2. **–ù–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª
   cat .env | grep -E "(BOT_TOKEN|API_BASE_URL)"
   ```

3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç
   docker exec dieta-bot-1 python -c "import sqlite3; print('DB OK')"
   ```

4. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ Redis
   docker logs dieta-bot-1 2>&1 | grep -i redis
   ```

5. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥—Ä—É–≥–∏–º –±–æ—Ç–æ–º** (TelegramConflictError)
   ```bash
   # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
   ps aux | grep 'main.py' | grep -v grep
   ```

### –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –±–æ—Ç–æ–º:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
docker-compose stop bot

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å .env
nano .env

# 3. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose up -d --build bot

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs dieta-bot-1 -f
```

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –õ–û–ì–û–í

### –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤:

```bash
# –°–æ–∑–¥–∞—Ç—å alias –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
echo 'alias docker-logs-size="sudo du -sh /var/lib/docker/containers/*/"' >> ~/.bashrc
source ~/.bashrc

# –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ:
docker-logs-size
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (cron):

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
sudo crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 3:00):
0 3 * * 0 /usr/bin/docker system prune -f --volumes > /dev/null 2>&1
```

---

## ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < 100MB)
sudo du -sh /var/lib/docker/containers/

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å Up)
docker-compose ps

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±–æ—Ç–∞ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫)
docker logs dieta-bot-1 --tail 50

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ
df -h /
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
CONTAINER ID   IMAGE              STATUS
122ada5cb082   dieta-frontend     Up 2 minutes
ad43f75183c3   dieta-bot          Up 2 minutes   ‚úÖ (–Ω–µ Restarting!)
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´

### –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Å–∏—Å—Ç–µ–º—É Docker:

```bash
# ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–∏—Ç –≤—Å–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ!
docker system prune -a --volumes

# –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç –æ—á–∏—â–µ–Ω–æ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
docker system df
```

### –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π:

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
mkdir -p ~/docker-logs-backup
docker logs dieta-bot-1 > ~/docker-logs-backup/bot-$(date +%Y%m%d).log
docker logs dieta-frontend > ~/docker-logs-backup/frontend-$(date +%Y%m%d).log
```

---

## üìû –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–∏—á–∏–Ω—É**: `docker logs dieta-bot-1 --tail 200`
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞**: `free -h` –∏ `df -h`
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**: `docker exec dieta-bot-1 env`
4. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë**: `docker-compose down && docker-compose up -d --build`

–ï—Å–ª–∏ –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø–∞–¥–∞—Ç—å - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã:
```bash
docker logs dieta-bot-1 --tail 100 > bot_error.log
cat bot_error.log
```

