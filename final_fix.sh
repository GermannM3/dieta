#!/bin/bash

echo "üöÄ –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose down
docker stop $(docker ps -aq) 2>/dev/null || true

# –û—á–∏—â–∞–µ–º Docker –ø–æ–ª–Ω–æ—Å—Ç—å—é
echo "üßπ –û—á–∏—â–∞–µ–º Docker..."
docker system prune -af --volumes

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –±–µ–∑ –∫—ç—à–∞
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞–µ–º
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 45

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º API..."
curl -f http://5.129.198.80:8000/health && echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend..."
curl -f http://5.129.198.80:3000 && echo "‚úÖ Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx –ª–æ–≥–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º nginx –ª–æ–≥–∏..."
docker-compose logs nginx --tail=10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–º–µ–Ω—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–º–µ–Ω—ã..."
curl -f -k https://—Ç–≤–æ–π-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.—Ä—Ñ && echo "‚úÖ –î–æ–º–µ–Ω —Ç–≤–æ–π-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.—Ä—Ñ —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå –î–æ–º–µ–Ω —Ç–≤–æ–π-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.—Ä—Ñ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
curl -f -k https://tvoi-kalkulyator.ru && echo "‚úÖ –î–æ–º–µ–Ω tvoi-kalkulyator.ru —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo "‚ùå –î–æ–º–µ–Ω tvoi-kalkulyator.ru –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

echo "‚úÖ –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" 