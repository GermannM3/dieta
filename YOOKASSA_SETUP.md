# Настройка YooKassa для Dieta Bot

## 1. Настройка в личном кабинете YooKassa

### Шаг 1: Регистрация и создание магазина
1. Зайдите на [yookassa.ru](https://yookassa.ru)
2. Зарегистрируйтесь как ИП или юридическое лицо
3. Создайте магазин в личном кабинете

### Шаг 2: Получение API ключей
1. В личном кабинете перейдите в раздел "Настройки" → "API"
2. Скопируйте:
   - **Shop ID** (например: 381764678)
   - **Secret Key** (например: TEST:132209)

### Шаг 3: Настройка webhook
1. В личном кабинете перейдите в "Настройки" → "Уведомления"
2. Добавьте URL для webhook:
   ```
   https://5.129.198.80/api/payment/yookassa/webhook
   ```
3. Выберите события для уведомлений:
   - ✅ `payment.succeeded` (обязательно)
   - ✅ `payment.canceled` (опционально)
   - ✅ `payment.waiting_for_capture` (опционально)

## 2. Настройка переменных окружения

Убедитесь, что в файле `.env` на сервере есть следующие переменные:

```env
# YooMoney Payment Configuration
YOOKASSA_SHOP_ID=381764678
YOOKASSA_SECRET_KEY=TEST:132209
YOOKASSA_PAYMENT_TOKEN=381764678:TEST:132209

# Subscription Settings
SUBSCRIPTION_PRICE=200
SUBSCRIPTION_DURATION_DAYS=7
```

## 3. Проверка работы

### Тест webhook
1. Создайте тестовый платеж через бота
2. Проверьте логи сервера:
   ```bash
   journalctl -u dieta-bot.service -f
   ```
3. Должно появиться сообщение: "Получен webhook от YooKassa"

### Проверка активации подписки
1. После успешной оплаты пользователь должен получить премиум-статус
2. Проверьте в базе данных:
   ```sql
   SELECT tg_id, is_premium FROM users WHERE tg_id = <user_id>;
   ```

## 4. Возможные проблемы

### Webhook не приходит
- Проверьте, что URL webhook правильный и доступен из интернета
- Убедитесь, что порт 8000 открыт в файрволе
- Проверьте, что nginx проксирует запросы на API

### Ошибка "Payment not found"
- Проверьте, что Shop ID и Secret Key правильные
- Убедитесь, что платеж создается с правильными метаданными

### Подписка не активируется
- Проверьте логи API сервера
- Убедитесь, что таблица `subscriptions` создана в базе данных
- Проверьте, что webhook обрабатывается корректно

## 5. Переход в продакшн

Для перехода в продакшн:
1. Замените тестовые ключи на боевые в личном кабинете YooKassa
2. Обновите переменные окружения на сервере
3. Перезапустите сервис:
   ```bash
   systemctl restart dieta-bot.service
   ```

## 6. Мониторинг

Для мониторинга платежей используйте:
```bash
# Логи сервиса
journalctl -u dieta-bot.service -f

# Логи API сервера
tail -f api_server.log

# Статус сервиса
systemctl status dieta-bot.service
``` 