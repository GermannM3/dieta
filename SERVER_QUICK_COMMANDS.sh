#!/bin/bash
# üöÄ –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –°–ï–†–í–ï–†–ê
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –Ω—É–∂–Ω—É—é –∫–æ–º–∞–Ω–¥—É –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª —Å–µ—Ä–≤–µ—Ä–∞

# ===================================================================
# üîå –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£
# ===================================================================
# ssh root@5.129.198.80
# –ü–∞—Ä–æ–ª—å: z.BqR?PLrJ8QZ8


# ===================================================================
# üìä –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
# ===================================================================

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
df -h /

# –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ Docker (–≥–ª–∞–≤–Ω—ã–π –≤–∏–Ω–æ–≤–Ω–∏–∫!)
sudo du -sh /var/lib/docker/containers/

# –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
sudo du -sh /var/lib/docker/containers/*/

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞ (–Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É –ø–∞–¥–µ–Ω–∏—è)
docker logs dieta-bot-1 --tail 100


# ===================================================================
# üóëÔ∏è –û–ß–ò–°–¢–ö–ê –õ–û–ì–û–í (–≤—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç)
# ===================================================================

# –í–ê–†–ò–ê–ù–¢ 1: –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
cd /opt/dieta && docker-compose stop && truncate -s 0 /var/lib/docker/containers/*/*-json.log && docker-compose up -d && docker-compose ps

# –í–ê–†–ò–ê–ù–¢ 2: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ Docker
cd /opt/dieta && docker-compose down && docker system prune -a -f && git pull && docker-compose up -d --build && docker-compose ps


# ===================================================================
# ‚öôÔ∏è –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ù–û–í–´–• –ù–ê–°–¢–†–û–ï–ö (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤)
# ===================================================================

# –°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å GitHub –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å
cd /opt/dieta && git stash && git pull origin main && docker-compose down && docker-compose up -d --build

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
docker inspect dieta-bot-1 | grep -A 5 "LogConfig"
docker inspect dieta-frontend-1 | grep -A 5 "LogConfig"


# ===================================================================
# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –° –ë–û–¢–û–ú
# ===================================================================

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –±–æ—Ç–∞
docker logs dieta-bot-1 --tail 200 | grep -i "error\|exception" -A 3

# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker logs dieta-bot-1 -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:8000/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
docker exec dieta-bot-1 env | grep -E "(BOT_TOKEN|API_BASE_URL)"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å .env —Ñ–∞–π–ª
cat /opt/dieta/.env | grep -E "(TG_TOKEN|DATABASE_URL|API_BASE_URL)"


# ===================================================================
# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–î–ê–Æ–©–ï–ì–û –ë–û–¢–ê
# ===================================================================

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
docker-compose restart bot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API (–µ—Å–ª–∏ –±–æ—Ç –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API)
docker-compose restart api && sleep 5 && docker-compose restart bot

# –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ
docker-compose restart

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –±–æ—Ç–∞ —Å –Ω—É–ª—è
docker-compose stop bot && docker-compose up -d --build bot


# ===================================================================
# ‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# ===================================================================

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
echo "=== –î–ò–°–ö ===" && df -h / && echo && echo "=== –õ–û–ì–ò ===" && sudo du -sh /var/lib/docker/containers/ && echo && echo "=== –ö–û–ù–¢–ï–ô–ù–ï–†–´ ===" && docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
sudo du -sh /var/lib/docker/containers/

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å Up!)
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats --no-stream


# ===================================================================
# üìù –ü–†–û–°–ú–û–¢–† –õ–û–ì–û–í
# ===================================================================

# –õ–æ–≥–∏ –±–æ—Ç–∞
docker logs dieta-bot-1 --tail 50
docker logs dieta-bot-1 -f  # —Å–ª–µ–¥–∏—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

# –õ–æ–≥–∏ API
docker logs dieta-api-1 --tail 50

# –õ–æ–≥–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
docker logs dieta-frontend-1 --tail 50

# –í—Å–µ –ª–æ–≥–∏ —Å—Ä–∞–∑—É
docker-compose logs --tail 50


# ===================================================================
# üö® –≠–ö–°–¢–†–ï–ù–ù–´–ï –ö–û–ú–ê–ù–î–´ (–µ—Å–ª–∏ –≤—Å—ë —Å–ª–æ–º–∞–ª–æ—Å—å)
# ===================================================================

# –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down

# –£–±–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Python
sudo pkill -f python

# –û—á–∏—Å—Ç–∏—Ç—å Docker –ø–æ–ª–Ω–æ—Å—Ç—å—é
docker system prune -a -f --volumes

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë —Å –Ω—É–ª—è
cd /opt/dieta && docker-compose down && docker-compose up -d --build


# ===================================================================
# üîÑ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–ï–ö–¢–ê –° GITHUB
# ===================================================================

# –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
cd /opt/dieta && git stash && git pull origin main && docker-compose down && docker-compose up -d --build


# ===================================================================
# üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì (–¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
# ===================================================================

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
cd /opt/dieta && sudo bash monitor_docker_disk.sh

# –î–æ–±–∞–≤–∏—Ç—å –≤ cron (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00)
# sudo crontab -e
# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É: 0 3 * * 0 truncate -s 0 /var/lib/docker/containers/*/*-json.log


# ===================================================================
# üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢
# ===================================================================

# –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
# - –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤: ~80MB (–≤–º–µ—Å—Ç–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö GB)
# - –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å—Ç–∞—Ç—É—Å–µ "Up" (–Ω–µ "Restarting")
# - –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Telegram
# - API –¥–æ—Å—Ç—É–ø–µ–Ω: http://5.129.198.80:8000/health
# - Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç: http://5.129.198.80:3000

